# Screenshoter — Система сравнения веб-интерфейсов

Проект **Screenshoter** предназначен для автоматизированного сравнения веб-страниц путём анализа скриншотов. Он позволяет выявлять визуальные отличия между двумя версиями страницы, что полезно для тестирования пользовательского интерфейса, контроля изменений и CI/CD.

Система состоит из нескольких компонентов, работающих совместно через REST API и объединённых в единую инфраструктуру с помощью Docker.

## Компоненты системы

### 1. `screenshoter`
**Назначение:** Сервис для генерации скриншотов веб-страниц.

- Принимает URL и параметры отображения (размер окна).
- Использует `Puppeteer` через PHP-обёртку `spatie/browsershot`.
- Сохраняет скриншоты в публичную директорию.
- Защита API ключом (`SCREENSHOT_API_KEY`).

### 2. `comparator`
**Назначение:** Сервис сравнения двух скриншотов.

- Принимает URL двух изображений.
- Сравнивает их с заданным порогом различий (`threshold`).
- Возвращает процент отклонения и наложенный результат с красными зонами отличий.
- Использует библиотеку `Imagick`.
- Защита API ключом (`DIFF_SERVICE_API_KEY`).

### 3. `webapp`
**Назначение:** API.

- Предоставляет API оконечники для запуска сравнения и просмотра результатов
- Интегрируется с `screenshoter` и `comparator`
- Обработка данных происходит через очередь сообщений

API получает список пар сравниваемых URL и дополнительные параметры (метод, тело запроса, заголовки, разрешение экрана, допустимый порог различия, возможно что-то ещё) для проверки (метод POST /job или типа того, возвращает job_uuid для проверки прогресса и результатов).
Пример **POST /api/jobs** запроса создания новой задачи:
   ```json
{
"urls": [
   {
      "after": "https://menotica.ru/sets/tproduct/666258712-279965050751-nabor-plan-with-me",
      "before": "https://menotica.ru/sets/tproduct/666258712-291142885991-nabor-big-plans"
   },
   {
      "after": "https://dobro.ru/event/10235276", 
      "before": "https://dobro.ru/event/11434992"
   }
],
"options": {
"width": 1920,
"height": 1080,
"threshold": 0.1
}
}
   ```

В цикле вызывает сервис, делающий скриншоты для каждой пары URL, по готовности передает готовые скриншоты или ссылки на них и параметры сравнения в сервис сравнения. Результат сравнения и визуальную разницу (поискать библиотеку визуализации различий) сохраняет в job.

Эндпоинт **GET /api/job/{job_uuid}** отдает текущий прогресс задачи и имеющиеся результаты сравнения.
Пример результатов сравнения:
```json
[
   {
      "beforeScreenshot":"\/screenshots\/1770878054-7c88845f.png",
      "afterScreenshot":"\/screenshots\/1770878059-d256f629.png",
      "urls":
      {
         "after":"https:\/\/menotica.ru\/sets\/tproduct\/666258712-279965050751-nabor-plan-with-me",
         "before":"https:\/\/menotica.ru\/sets\/tproduct\/666258712-291142885991-nabor-big-plans"
      },
      "difference_percent":19.96,
      "diff_image_url":"\/diffs\/diff-1770878065-ac764c08.png"
   },
   {
      "beforeScreenshot":"\/screenshots\/1770878066-d868a2bb.png",
      "afterScreenshot":"\/screenshots\/1770878072-28f61681.png",
      "urls":
      {
         "after":"https:\/\/dobro.ru\/event\/10235276",
         "before":"https:\/\/dobro.ru\/event\/11434992"
      },
      "difference_percent":20.52,
      "diff_image_url":"\/diffs\/diff-1770878083-f6ed6327.png"
   }
]
```
в полях *beforeScreenshot*, *afterScreenshot* и *diff_image_url* - относительные пути до полученных изображений.

Эндпоинт **DELETE /api/jobs/{job_uuid}** удаляет задачу и все артефакты.

Эндпоинт **GET /api/jobs** отдает список задач пользователя (пока пользователь = 0)

### 4. `docker`
**Назначение:** Конфигурация инфраструктуры.

- Содержит `docker-compose.yaml` для запуска всех сервисов.
- Определяет сети, тома, переменные окружения.
- Обеспечивает изолированное, воспроизводимое окружение.

## Развертывание

1. Убедитесь, что Docker запущен.
2. Перейдите в директорию `docker`:
   ```bash
   cd docker
   ```
3. Запустите скрипт:
   ```bash
   ./up.sh
   ```
   И выберите "1" для запуска всех сервисов

## Переменные окружения

Переменные задаются в `.env`-файле или через переменные окружения хоста. Основные:

| Переменная | Назначение                                   | Пример |
|------------|----------------------------------------------|--------|
| `SCREENSHOT_BASE_URL` | Базовый URL сервиса для сравнения скриншотов | `http://comparator:8081` |
| `DIFF_SERVICE_API_KEY` | API-ключ для доступа к сервису comparator    | `secret456` |
| `SCREENSHOT_BASE_URL` | Базовый URL сервиса для генерации скриншотов | `http://screenshoter:8080` |
| `SCREENSHOT_API_KEY` | API-ключ для доступа к screenshoter          | `secret123` |



## Формат выходного изображения различий

Изображение создаётся в формате **PNG** с альфа-каналом. Отличия выделяются **полупрозрачным красным цветом (RGBA)**, наложенным поверх первого скриншота. Это позволяет чётко видеть:

- Места изменений (красные зоны).
- Оригинальное содержимое под наложением.

Файл сохраняется в директории diffs и доступен по HTTP.

## Возможные ошибки

| Ошибка | Причина | Решение |
|-------|--------|--------|
| `Invalid API key` | Неверный или отсутствующий `X-Api-Key` | Проверьте ключ и заголовок запроса |
| `Failed to load one or both images` | Неверный URL скриншота или сервис `screenshoter` недоступен | Убедитесь, что скриншоты существуют и `screenshoter` работает |
| `Resize failed` | Ошибка изменения размера изображения | Проверьте корректность изображений и библиотеку Imagick |
| `Image comparison failed` | Общая ошибка сравнения | Проверьте логи сервиса `comparator` |
| `Method not allowed` | Использован не `POST` запрос | Используйте `POST` |

---

> **Примечание:** Все сервисы взаимодействуют в рамках одной Docker-сети (`screenshoter`). Внутренние URL (вроде `http://screenshoter:8080`) используются для межсервисной коммуникации, а внешние — для доступа извне.
