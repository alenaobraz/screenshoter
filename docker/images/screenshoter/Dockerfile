# –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–∑ PHP CLI
FROM php:8.4-cli

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
RUN apt-get update && apt-get install -y \
    wget \
    git \
    curl \
    unzip \
    libpng-dev \
    libjpeg-dev \
    libfreetype6-dev \
    locales \
    && rm -rf /var/lib/apt/lists/*

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–∫–∞–ª–∏
RUN locale-gen en_US.UTF-8
ENV LANG=en_US.UTF-8
ENV LANGUAGE=en_US:en
ENV LC_ALL=en_US.UTF-8

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ GD
RUN docker-php-ext-configure gd --with-freetype --with-jpeg \
    && docker-php-ext-install gd

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js 18.x
RUN curl -fsSL https://deb.nodesource.com/setup_18.x | bash - \
    && apt-get install -y nodejs

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Puppeteer –≥–ª–æ–±–∞–ª—å–Ω–æ
RUN npm install -g puppeteer --unsafe-perm=true

# üîß –í–ê–ñ–ù–û: –¥–æ–±–∞–≤–ª—è–µ–º NODE_PATH
ENV NODE_PATH=/usr/lib/node_modules:/usr/local/lib/node_modules

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Chromium
RUN apt-get update && apt-get install -y \
    chromium \
    chromium-driver \
    && ln -s /usr/bin/chromium /usr/bin/chromium-browser

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
RUN node -v && npm -v
RUN chromium-browser --version
RUN node -e "require('puppeteer')" || echo "Puppeteer require failed"

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Composer
COPY --from=composer:latest /usr/bin/composer /usr/bin/composer

WORKDIR /app

COPY composer.json .
RUN composer install --no-dev --optimize-autoloader

COPY . .

RUN mkdir -p /app/public/screenshots && chmod -R 777 /app/public/screenshots

# –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ /tmp
RUN chmod 1777 /tmp

EXPOSE 8080

CMD ["php", "-S", "0.0.0.0:8080", "-t", "public"]